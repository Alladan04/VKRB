# API для взаимодействия с миварной системой
В этой директории находится код для центрального сервиса - сервиса взаимодействия с миварной системой. 
Он предоставляет API взаимодействия с миварной системой.

## Логика
#### Запуск сервиса
При запуске сервиса, вызывается ```Manager```, который считывает файлы лабиринтов,
(директории и мета-информация задаются конфигом в корне проекта).
Далее:
- Лабиринты загружаются в кэш
- Генерируется XML, который загружается в WiMI и в кэш

После этого сервис становится доступен и может принимать запросы.

При завершении работы сервиса используем graceful shutdown.


# CalculatePath
Вычисляет  маршрут между точками в лабиринте и возвращает последовательность переходов.

---

## **Запрос**
### **Заголовки**
- `Content-Type`: `application/json` (обязательно)

### **Тело запроса (`CalculatePathRequest`)**
```json
{
  "start": { "x": 0, "y": 1 },
  "end": [
    { "x": 5, "y": 5 },
    { "x": 10, "y": 10 }
  ],
  "labirintID": 12345
}
```
| Поле         | Тип       | Описание                            | Обязательно |
|--------------|-----------|-------------------------------------|-------------|
| `start`      | `Point`   | Стартовая точка маршрута.           | Да          |
| `end`        | `Point[]` | Массив конечных точек маршрута.     | Нет         |
| `labirintID` | `int64`   | Уникальный идентификатор лабиринта. | Да          |

### **Структура `Point`**
```go
type Point struct {
  X int64 `json:"x"`  // Координата X (столбец)
  Y int64 `json:"y"`  // Координата Y (строка)
}
```

---

## **Ответ**
### **Успешный ответ (`HTTP 200`)**
```json
{
  "path": [
    {
      "start": { "x": 0, "y": 1 },
      "end": { "x": 1, "y": 1 }
    },
    {
      "start": { "x": 1, "y": 1 },
      "end": { "x": 2, "y": 1 }
    }
  ],
  "time": 2
}
```
| Поле        | Тип              | Описание                                  |
|-------------|------------------|-------------------------------------------|
| `path`      | `Transition[]`   | Последовательность переходов маршрута.    |
| `time`      | `int64`          | Время вычисления маршрута в наносекундах. |

### **Структура `Transition`**
```go
type Transition struct {
  From Point `json:"start"`  // Начало отрезка пути
  To   Point `json:"end"`    // Конец отрезка пути
}
```

### **Ошибки**
| Код состояния | Сообщение об ошибке         | Описание                           |
|---------------|-----------------------------|------------------------------------|
| `400`         | `"invalid request"`         | Неверный формат запроса.           |
| `404`         | `"labirint not found"`      | Лабиринт с указанным ID не найден. |
| `500`         | `"path calculation failed"` | Ошибка при вычислении маршрута.    |

---

## **Пример запроса (cURL)**
```bash
curl -X POST 'http://127.0.0.1:8080/calc_path' \
  -H 'Content-Type: application/json' \
  -d '{
    "start": { "x": 0, "y": 1 },
    "end": [
      { "x": 5, "y": 5 },
      { "x": 10, "y": 10 }
    ],
    "labirintID": 12345
  }'
```

## **Алгоритм работы**
1. **Валидация запроса**: Проверяет наличие обязательных полей.
2. **Поиск лабиринта**: Загружает лабиринт по `labirintID`.
3. **Расчет маршрута**: Вычисляет оптимальный путь от `start` до каждой точки в `end`.
4. **Формирование ответа**: Возвращает:
    - Последовательность переходов (`path`)
    - Время выполнения расчета (`time`)

---

## **Примечания**
1. Координатная система:
    - `X` - номер столбца (слева направо, начиная с 0)
    - `Y` - номер строки (сверху вниз, начиная с 0)
2. Особенности:
    - Возвращает маршрут до точек из массива `end` (не гарантирует, что путь кратчайший)
    - Время выполнения (`time`) включает только расчет маршрута


Если передан пустой массив ```End``` - самостоятельно найдет все доступные выходы.

---
Отлично, вот документация к ручке `UpdateMap`, оформленная в том же стиле, что и для `CalculatePath`.

---

# UpdateMap
Обновляет структуру лабиринта, заменяя или добавляя переданные точки, и возвращает обновлённую карту.

---

## **Запрос**
### **Заголовки**
- `Content-Type`: `application/json` (обязательно)

### **Тело запроса (`UpdateMapIn`)**
```json
{
  "labirintID": 12345,
  "points": [
    { "x": 1, "y": 2 },
    { "x": 3, "y": 4 }
  ]
}
```

| Поле         | Тип       | Описание                                      | Обязательно |
|--------------|-----------|-----------------------------------------------|-------------|
| `labirintID` | `int64`   | Уникальный идентификатор лабиринта.           | Да          |
| `points`     | `Point[]` | Массив точек, которые необходимо обновить.    | Да          |

### **Структура `Point`**
```go
type Point struct {
  X int64 `json:"x"`  // Координата X (столбец)
  Y int64 `json:"y"`  // Координата Y (строка)
}
```

---

## **Ответ**
### **Успешный ответ (`HTTP 200`)**
```json
{
  "labirint": [
    [0, 1, 0],
    [0, 0, 1],
    [1, 0, 0]
  ]
}
```

| Поле       | Тип         | Описание                                  |
|------------|-------------|-------------------------------------------|
| `labirint` | `int[][]`   | Обновлённая матрица лабиринта.            |

> Значения матрицы представляют состояние каждой ячейки:
> - `0` — проходимая ячейка
> - `1` — препятствие / стена

---

## **Ошибки**
| Код состояния | Сообщение об ошибке     | Описание                                        |
|---------------|--------------------------|-------------------------------------------------|
| `400`         | `"can't read body"`      | Ошибка при чтении тела запроса.                 |
| `400`         | `"can't parse body"`     | Ошибка при разборе JSON тела запроса.          |
| `500`         | `"can't update labirint"`| Ошибка при обновлении карты лабиринта.          |

---

## **Пример запроса (cURL)**
```bash
curl -X POST 'http://127.0.0.1:8080/update_map' \
  -H 'Content-Type: application/json' \
  -d '{
    "labirintID": 12345,
    "points": [
      { "x": 1, "y": 2 },
      { "x": 3, "y": 4 }
    ]
  }'
```

---

## **Алгоритм работы**
1. **Валидация запроса**: Проверяет, что тело запроса валидно и содержит обязательные поля.
2. **Обработка точек**: Преобразует массив точек из DTO в сущности.
3. **Обновление карты**: Передаёт точки и `labirintID` в usecase для обновления карты.
4. **Формирование ответа**: Возвращает обновлённую структуру лабиринта в виде двумерной матрицы.

---

## **Примечания**
1. Координатная система:
   - `X` — номер столбца (слева направо, начиная с 0)
   - `Y` — номер строки (сверху вниз, начиная с 0)
2. Если указанные точки выходят за границы существующего лабиринта — возможна ошибка обновления.
3. Переданные точки инвертируют значение в ячейке лабиринта, если `1` — на `0`, если `0` — на `1`.

---

Вот документация для ручки `Restore`, оформленная в том же стиле, как и предыдущие:

---

# Restore
Восстанавливает карту лабиринта по переданному `labirint_id` и возвращает её в виде матрицы.

---

## **Запрос**
### **Метод:** `POST`

### **Параметры запроса**
| Параметр      | Тип     | Описание                                      | Обязательно |
|---------------|---------|-----------------------------------------------|-------------|
| `labirint_id` | `string`| Уникальный идентификатор лабиринта.           | Да          |

> `labirint_id` передаётся как query-параметр в URL:  
> `...?labirint_id=12345`

---

## **Ответ**
### **Успешный ответ (`HTTP 200`)**
```json
{
  "labirint": [
    [0, 1, 0],
    [0, 0, 1],
    [1, 0, 0]
  ]
}
```

| Поле       | Тип         | Описание                                  |
|------------|-------------|-------------------------------------------|
| `labirint` | `int[][]`   | Восстановленная структура лабиринта.      |

> Значения матрицы:
> - `0` — проходимая ячейка
> - `1` — препятствие / стена

---

## **Ошибки**
| Код состояния | Сообщение об ошибке | Описание                                   |
|---------------|----------------------|--------------------------------------------|
| `500`         | `"can't restore"`    | Ошибка при восстановлении лабиринта.       |

---

## **Пример запроса (cURL)**
```bash
curl -X POST 'http://127.0.0.1:8080/restore?labirint_id=12345'
```

---

## **Алгоритм работы**
1. **Получение параметров**: Извлекает `labirint_id` из строки запроса.
2. **Восстановление модели**: Вызывает usecase для загрузки модели лабиринта.
3. **Формирование ответа**: Возвращает лабиринт в виде двумерного массива (`labirint`).

---

## **Примечания**
1. Координатная система:
   - `X` — номер столбца (слева направо, начиная с 0)
   - `Y` — номер строки (сверху вниз, начиная с 0)
2. Возвращаемая карта соответствует данным, заданным в системе при первой загрузке.

---
